{% if page.comments == true %}
<form id="comment-form" action="{{ site.staticman.api }}">
  <!-- Backend expects a postId; using the page slug by default -->
  <input type="hidden" id="postId" value="{{ page.slug }}">
  <!-- Optional redirect you can override; backend also returns success/failure -->
  <input type="hidden" id="redirect" value="/pages/thank-you">

  <div class="form-container">
    <div class="image-container">
      <img id="robohash-image" src="https://robohash.org/default" alt="Robohash Image">
    </div>
    <div class="input-container">
      <label for="name">Display Name</label>
      <input type="text" id="name" required>

      <label for="email">E-mail (Optional)</label>
      <input type="email" id="email">

      <label for="url">Your URL (Optional)</label>
      <input type="text" id="url">

      <label for="message">Message</label>
      <textarea id="message" rows="4" required></textarea>

      <label><input id="remember_me" type="checkbox"> Remember me</label>
      <br/>

      <!-- reCAPTCHA: keep only the site key on the client -->
      <div class="g-recaptcha" data-sitekey="{{ site.staticman.recaptcha.sitekey }}"></div>

      <div class="warning-box" id="warning-box"></div>
      <button type="submit" class="submit-button">Submit</button>
    </div>
  </div>
</form>

<script>
$(document).ready(function () {
  function saveToLocalStorage() {
    if ($('#remember_me').is(':checked')) {
      localStorage.setItem('name', $('#name').val());
      localStorage.setItem('email', $('#email').val());
      localStorage.setItem('url', $('#url').val());
      localStorage.setItem('avatar_url', $('#avatar_url').val());
    }
  }

  function loadFromLocalStorage() {
    if (localStorage.getItem('name')) {
      $('#name').val(localStorage.getItem('name'));
      $('#email').val(localStorage.getItem('email'));
      $('#url').val(localStorage.getItem('url'));
      const savedAvatar = localStorage.getItem('avatar_url');
      if (savedAvatar) $('#robohash-image').attr('src', savedAvatar);
    }
  }

  // Keep an in-memory avatarUrl; generate from name (or swap to email if you prefer)
  let avatarUrl = 'https://robohash.org/default';
  $('#name').on('blur', function () {
    const val = $(this).val().trim();
    if (val) {
      avatarUrl = `https://robohash.org/${encodeURIComponent(val)}`;
      $('#robohash-image').attr('src', avatarUrl);
      if ($('#remember_me').is(':checked')) {
        localStorage.setItem('avatar_url', avatarUrl);
      }
    }
  });

  $('#comment-form').on('submit', function (event) {
    event.preventDefault();

    const warningBox = document.getElementById('warning-box');
    const captchaResponse = grecaptcha.getResponse();

    if (!captchaResponse) {
      warningBox.textContent = 'Please complete the reCAPTCHA.';
      warningBox.style.display = 'block';
      return;
    } else {
      warningBox.style.display = 'none';
    }

    const $submitButton = $('.submit-button');
    $submitButton.prop('disabled', true).text('Submitting...');

    // Build payload for backend
    const payload = {
      postId: $('#postId').val() || '',
      name: $('#name').val().trim(),
      message: $('#message').val().trim(),
      email: $('#email').val().trim() || '',
      url: $('#url').val().trim() || '',
      avatarUrl: avatarUrl,
      gRecaptchaResponse: captchaResponse,
    };

    // Basic front-end validation
    if (!payload.name || !payload.message) {
      warningBox.textContent = 'Name and message are required.';
      warningBox.style.display = 'block';
      $submitButton.prop('disabled', false).text('Submit');
      return;
    }

    // Persist (if requested)
    saveToLocalStorage();

    // Send JSON body
    $.ajax({
      url: $('#comment-form').attr('action'),
      type: 'POST',
      data: JSON.stringify(payload),
      processData: false,
      contentType: 'application/json; charset=UTF-8',
      success: function (data) {
        // If your backend returns a boolean or an object with success/message
        const ok = (data === true) || (data && data.success);
        if (ok) {
          window.location.href = '/pages/thank-you';
        } else {
          console.error('Error submitting comment:', data && data.message);
          window.location.href = '/pages/sorry';
        }
      },
      error: function (jqXHR, textStatus, errorThrown) {
        console.error('Error:', errorThrown);
        console.error('Status:', textStatus);
        console.error('Response:', jqXHR.responseText);
        window.location.href = '/pages/sorry';
      },
      complete: function () {
        // Reset captcha so user can retry if needed
        grecaptcha.reset();
        $submitButton.prop('disabled', false).text('Submit');
      }
    });
  });

  loadFromLocalStorage();
});
</script>
{% endif %}
